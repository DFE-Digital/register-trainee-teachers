# frozen_string_literal: true

require "rails_helper"

RSpec.describe MalwareScanningJob do
  include ActiveJob::TestHelper

  let!(:pending_uploads) { create_list(:upload, 3, malware_scan_result: "pending", created_at: 6.minutes.ago) }
  let!(:recent_uploads) { create_list(:upload, 2, malware_scan_result: "pending", created_at: 1.minute.ago) }

  before do
    allow(MalwareScanJob).to receive(:perform_later)
  end

  it "queues the job for pending uploads older than 5 minutes" do
    MalwareScanningJob.perform_now

    expect(MalwareScanJob).to have_received(:perform_later).exactly(3).times
  end

  it "does not queue the job for pending uploads younger than 5 minutes" do
    MalwareScanningJob.perform_now

    recent_uploads.each do |upload|
      expect(MalwareScanJob).not_to have_received(:perform_later).with(upload_id: upload.id)
    end
  end
end
