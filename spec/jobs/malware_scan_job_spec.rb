# frozen_string_literal: true

require "rails_helper"

RSpec.describe MalwareScanJob do
  include ActiveJob::TestHelper

  let(:upload) { create(:upload) }

  before do
    allow(MalwareScan).to receive(:call)
  end

  it "queues the job" do
    expect { MalwareScanJob.perform_later(upload_id: upload.id) }
      .to change(ActiveJob::Base.queue_adapter.enqueued_jobs, :size).by(1)
  end

  it "calls MalwareScan service with the correct upload" do
    perform_enqueued_jobs do
      MalwareScanJob.perform_later(upload_id: upload.id)
    end

    expect(MalwareScan).to have_received(:call).with(upload:)
  end

  it "discards the job when upload is not found" do
    expect {
      perform_enqueued_jobs do
        MalwareScanJob.perform_later(upload_id: 9999)
      end
    }.not_to raise_error
  end
end
