# API load testing

For API load testing we make use of [k6](https://github.com/grafana/k6)

## Architecture

All our k6 code is located at [k6_load_testing](../../k6_load_testing)

### Directory structure

```
k6_load_testing
├── .example.secrets.json
├── .secrets.json
├── client.ts
├── endpoints
│   ├── delete-trainee-degree.ts
│   ├── delete-trainee-placement.ts
│   ├── get-trainee-degree.ts
│   ├── get-trainee-degrees.ts
│   ├── get-trainee-placement.ts
│   ├── get-trainee-placements.ts
│   ├── get-trainee.ts
│   ├── get-trainees.ts
│   ├── post-trainee-defer.ts
│   ├── post-trainee-degrees.ts
│   ├── post-trainee-placements.ts
│   ├── post-trainee-withdraw.ts
│   ├── post-trainees.ts
│   ├── put-trainee-degree.ts
│   ├── put-trainee-placement.ts
│   └── put-trainee.ts
├── k6-script.ts
├── registerAPI.ts
├── secrets.ts
└── setup.ts
```

#### Responsibilities

* `.example.secrets.json` Example template for secrets file
* `.secrets.json` Secrets file
* `client.ts` Instantiates the `RegisterAPIClient` defined in `registerAPI.ts`
* `endpoints` Contains function definitions per endpoint
* `k6-script.ts` Executes all the endpoint functions in a loop
* `registerAPI.ts` API client generated by our OpenAPI spec
* `secrets.ts` Reads and returns the secrets defined in `.secrets.json`
* `setup.ts` Returns the setup function required for the requests to be performed

### Configuration

The steps that we took to setup our k6 tests are the following:

1. Installed [openapi-to-k6](https://github.com/grafana/openapi-to-k6).
2. Generated the `RegisterAPIClient` and sample script from our [OpenAPI](../../public/openapi/v2025.0.yaml) spec. 
```
npx @grafana/openapi-to-k6 public/openapi/v2025.0.yaml . --include-sample-script

├── k6-script.ts
├── registerAPI.ts
```
3. Extracted the sample endpoint functions defined in `k6-script.sample.ts` to their own function definitions
under the `endpoints` dir. The request body was determined by our [request](../../spec/requests/api) specs to determine the request body per endpoint function.
4. Each endpoint function imports from `client.ts` and `setup.ts` to perform their corresponding request.
5. `k6-script.ts` has been refactored to import all the endpoint functions where they executed sequencially. The default
load testing region has been set to `London` with `100%` load distribution.

### How we perform our tests

> Prerequisite [k6 guide](k6_guide.md)

1. Scale up staging env to match production env
2. Use `k6 cloud run` to run `k6-script.ts` with a `duration` and `VUs`
```
k6 cloud run --vus 3 --duration 300s k6-script.ts
```
3. Monitor load test metrics in Grafana Cloud k6
4. Monitor web and worker pods in Grafana dashboards
5. Monitor db metrics in Azure Metrics
6. Document the results on Confluence
